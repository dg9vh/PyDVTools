#!/usr/bin/python3

import _thread
import socket
import time
import configparser
import os


def connect_client(clientName):
    global config
    message = clientName
    UDP_IP = config['DEFAULT']['Reflector_IP']
    UDP_PORT = int(config['DEFAULT']['Reflector_Port'])
    print("sent: %s" % message)

    sock = socket.socket(socket.AF_INET, # Internet
                     socket.SOCK_DGRAM) # UDP

    sock.sendto(message, (UDP_IP, UDP_PORT))
    data, addr = sock.recvfrom(1024) # buffer size is 1024 bytes
    print("received: %s" % data)

    while True:
        sock.sendto(message, (UDP_IP, UDP_PORT))
        data, addr = sock.recvfrom(1024) # buffer size is 1024 bytes
        time.sleep(10)


current_dir = os.getcwd()
config = configparser.ConfigParser()
config.read(current_dir + '/nxdnpentester.ini')

CONNECT = "NXDNP"
PREFIX = config['DEFAULT']['Prefix']

for i in range (1, int(config['DEFAULT']['Count']) + 1):
    connect_string = bytearray(CONNECT + PREFIX + str(i).zfill(10 - len(PREFIX)), "UTF-8")
    try:
        _thread.start_new_thread(connect_client, (connect_string,))
    except:
        print ("Error: unable to start thread")

    time.sleep(0.1)

while 1:
    pass
